<!DOCTYPE html>
<html>
<head>
<title>Jewels of Babylon: Routine at C21E</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-wide.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="C1FF.html">C1FF</a>
</td>
<td class="up">Up: <a href="../maps/all.html#c21e">Map</a></td>
<td class="next">
Next: <a href="C26A.html">C26A</a>
</td>
</tr>
</table>
<div class="description">C21E: Handler: Display Room Image</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="BB94.html">LoadTape</a>, <a href="EF54.html">EF54</a> and <a href="F03A.html">F03A</a>.
</div>
<div class="paragraph">
Determines if the current room has an image relating to it, and if it does - it jumps to the routine to display it.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">01 If the image should be displayed, 00 if it should be skipped</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c21e"></span>
<div class="comments">
<div class="paragraph">
The game can also load without any graphics at all, so bail if there's nothing needed to do here.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">Handler_DisplayRoomImage</td>
<td class="address-2"><span id="c21e"></span>C21E</td>
<td class="instruction">LD A,($BD2E)</td>
<td class="comment-1" rowspan="3">Jump to <a href="C26A.html">Handler_RoomExits</a> if *<a href="BD2E.html">Count_RoomsWithImages</a> is set to zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c221"></span>C221</td>
<td class="instruction">OR A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c222"></span>C222</td>
<td class="instruction">JR Z,<a href="C26A.html">Handler_RoomExits</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c224"></span>
<div class="comments">
<div class="paragraph">
The version of the game being played DOES have graphics, so continue.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c224"></span>C224</td>
<td class="instruction">LD A,($BCCB)</td>
<td class="comment-1" rowspan="1">Fetch *<a href="BCCB.html">RoomNumber</a> and load it into <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c227"></span>C227</td>
<td class="instruction">LD HL,($BD14)</td>
<td class="comment-1" rowspan="1">Fetch the address of the table from *<a href="BD14.html">Pointer_RoomsWithImages</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c22a"></span>C22A</td>
<td class="instruction">LD BC,($BD2E)</td>
<td class="comment-1" rowspan="1">Fetch the count of the number of rooms in the table from *<a href="BD2E.html">Count_RoomsWithImages</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c22e"></span>C22E</td>
<td class="instruction">CPIR</td>
<td class="comment-1" rowspan="1">Search to see if the current room ID is in the table.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c230"></span>C230</td>
<td class="instruction">JR NZ,<a href="C26A.html">Handler_RoomExits</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="C26A.html">Handler_RoomExits</a> if the current room ID does not appear in the table.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c232"></span>
<div class="comments">
<div class="paragraph">
The current room does have an image associated with it.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c232"></span>C232</td>
<td class="instruction">LD A,($BD2E)</td>
<td class="comment-1" rowspan="4">Calculate the index of the current room in the table.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c235"></span>C235</td>
<td class="instruction">INC C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c236"></span>C236</td>
<td class="instruction">SUB C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c237"></span>C237</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c238"></span>
<div class="comments">
<div class="paragraph">
The <span class="register">E</span> register is used as a flag to indicate that the room image should not be displayed, e.g. after the player has requested to view their inventory and have seen the room image already when they entered the location.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c238"></span>C238</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="3">Jump to <a href="C21E.html#c258">DisplayRoomImage</a> if <span class="register">E</span> was set to 01 (Display the image).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c239"></span>C239</td>
<td class="instruction">OR E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c23a"></span>C23A</td>
<td class="instruction">JR NZ,<a href="C21E.html#c258">DisplayRoomImage</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c23c"></span>
<div class="comments">
<div class="paragraph">
The game also maintains a table of "already seen room images" so the player doesn't have to view an image for a room they've already been in.
</div>
<div class="paragraph">
The player can view it manually by typing "LOOK" (or just "L").
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c23c"></span>C23C</td>
<td class="instruction">LD HL,$BC5C</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="BC5C.html">Table_RoomImagesAlreadySeen</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c23f"></span>C23F</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Copy the room image index into <span class="register">A</span>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c240"></span>
<div class="comments">
<div class="paragraph">
Only two bytes hold the data for all 0C rooms with images so first - find the correct byte which references this room.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">FindAlreadySeenByte_Loop</td>
<td class="address-2"><span id="c240"></span>C240</td>
<td class="instruction">CP $08</td>
<td class="comment-1" rowspan="2">Jump to <a href="C21E.html#c249">FoundAlreadySeenByte</a> if the room index is less than 08.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c242"></span>C242</td>
<td class="instruction">JR C,<a href="C21E.html#c249">FoundAlreadySeenByte</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c244"></span>C244</td>
<td class="instruction">SUB $08</td>
<td class="comment-1" rowspan="1">Subtract 08 from the room index.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c246"></span>C246</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Increment the "image already seen" table pointer by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c247"></span>C247</td>
<td class="instruction">JR <a href="C21E.html#c240">FindAlreadySeenByte_Loop</a></td>
<td class="comment-1" rowspan="1">Jump back to <a href="C21E.html#c240">FindAlreadySeenByte_Loop</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c249"></span>
<div class="comments">
<div class="paragraph">
Now the correct byte has been found, check the appropriate bit.
</div>
<div class="paragraph">
Create a mask with a single bit set corresponding to this rooms position (0-7) in the byte.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">FoundAlreadySeenByte</td>
<td class="address-2"><span id="c249"></span>C249</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Copy the "image already seen" byte into <span class="register">B</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c24a"></span>C24A</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Increment <span class="register">B</span> by one to get the correct number of shifts.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c24b"></span>C24B</td>
<td class="instruction">LD D,$00</td>
<td class="comment-1" rowspan="1">Start with all bits clear in <span class="register">D</span>.</td>
</tr>
<tr>
<td class="asm-label">AlreadySeenBitShift_Loop</td>
<td class="address-2"><span id="c24d"></span>C24D</td>
<td class="instruction">RL D</td>
<td class="comment-1" rowspan="1">Rotate 1 bit left into position.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c24f"></span>C24F</td>
<td class="instruction">DJNZ <a href="C21E.html#c24d">AlreadySeenBitShift_Loop</a></td>
<td class="comment-1" rowspan="1">Decrease the shift counter by one and loop back to <a href="C21E.html#c24d">AlreadySeenBitShift_Loop</a> until the bit is in the correct position.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c251"></span>
<div class="comments">
<div class="paragraph">
Test the bit held in <span class="register">D</span> against the room flag.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c251"></span>C251</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch the current room flag.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c252"></span>C252</td>
<td class="instruction">AND D</td>
<td class="comment-1" rowspan="2">If the room image has already been seen ... jump to <a href="C26A.html">Handler_RoomExits</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c253"></span>C253</td>
<td class="instruction">JR NZ,<a href="C26A.html">Handler_RoomExits</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c255"></span>
<div class="comments">
<div class="paragraph">
The room image hasn't already been seen, so update the bit to indicate that the player will have viewed it for the next time this routine runs.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c255"></span>C255</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="3">Merge the set room bit with the room flags and write the result back to the room flag byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c256"></span>C256</td>
<td class="instruction">OR D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c257"></span>C257</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="c258"></span>
<div class="comments">
<div class="paragraph">
Finally! Display the room image.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">DisplayRoomImage</td>
<td class="address-2"><span id="c258"></span>C258</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Temporarily stash <span class="register">BC</span> on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c259"></span>C259</td>
<td class="instruction">CALL <a href="BA6D.html">ClearScreen</a></td>
<td class="comment-1" rowspan="1">Call <a href="BA6D.html">ClearScreen</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c25c"></span>C25C</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore <span class="register">BC</span> from the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c25d"></span>C25D</td>
<td class="instruction">LD IX,($BD16)</td>
<td class="comment-1" rowspan="1">Fetch the address of the table from *<a href="BD16.html">Pointer_RoomImage</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c261"></span>C261</td>
<td class="instruction">LD E,C</td>
<td class="comment-1" rowspan="1">Load the location image index into <span class="register">E</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c262"></span>C262</td>
<td class="instruction">CALL <a href="C1F0.html">GetTableEntry</a></td>
<td class="comment-1" rowspan="1">Call <a href="C1F0.html">GetTableEntry</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c265"></span>C265</td>
<td class="instruction">LD DE,$C26A</td>
<td class="comment-1" rowspan="2">Push <a href="C26A.html">Handler_RoomExits</a> onto the stack so that the next return will go on to show the room exits.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c268"></span>C268</td>
<td class="instruction">PUSH DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="c269"></span>C269</td>
<td class="instruction">JP (HL)</td>
<td class="comment-1" rowspan="1">Jump to the routine pointed to by *<span class="register">HL</span> to display the room image.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="C1FF.html">C1FF</a>
</td>
<td class="up">Up: <a href="../maps/all.html#c21e">Map</a></td>
<td class="next">
Next: <a href="C26A.html">C26A</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; 1985 Interceptor Software UK &copy; 2025 ArcadeGeek LTD.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.6.</div>
<div class="repository">Link to <a rel="noopener nofollow" href="https://github.com/pobtastic/jewelsofbabylon/">Source code</a>.</div>
<div><a href="../dec/asm/49694.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>